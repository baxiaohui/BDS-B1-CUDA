#include <stdio.h>
#include <cstringt.h>
#include "gpssim.h"
void BDSB1Ccodegen(int* datacode, int* pilotcode, int* overlay, int satid)
{
	int N = 10243;
	int i, j, k;
	char Legendre[10243];
	int Pcode[10230];
	int Dcode[10230];
	int tmp;
	int p_weil, p_insert;
	int d_weil, d_insert;
	int o_weil, o_insert;
	//int o_s1coef,o_s1initchip,o_s2initchip, o_initchip,o_finalchip;

	int flag[3];

	int weilandp_data[] =
	{
2678,	699		,053773116,	042711657,
4802,	694		,032235341,	017306122,
958	,	7318	,017633713,	001145221,
859	,	2127	,041551514,	005307430,
3843,	715		,017205134,	046341377,
2232,	6682	,004254545,	060604443,
124	,	7850	,070663435,	050500234,
4352,	5495	,016701045,	027476454,
1816,	1162	,032132263,	070555612,
1126,	7682	,025432015,	043004057,
1860,	6792	,031711760,	007100551,
4800,	9973	,025604267,	015703521,
2267,	6596	,065705054,	012615632,
424	,	2092	,024700370,	014267226,
4192,	19		,072405456,	025330122,
4333,	10151	,002621063,	015741134,
2656,	6297	,000506754,	062665617,
4148,	5766	,044317266,	007251312,
243	,	2359	,014463723,	026526763,
1330,	7136	,070234110,	033737311,
1593,	1706	,062002462,	034564677,
1470,	2128	,052312612,	030142557,
882	,	6827	,034500023,	052015335,
3202,	693		,077312776,	056550366,
5095,	9729	,003712305,	004531416,
2546,	1620	,002501573,	000717773,
1733,	6805	,066632544,	065070030,
4795,	534		,000447425,	065742570,
4577,	712		,050643132,	047674377,
1627,	1929	,075652754,	045534064,
3638,	5355	,040610704,	003636755,
2553,	6139	,060523643,	052040645,
3646,	6339	,030522043,	036645510,
1087,	1470	,006337743,	054551553,
1843,	6867	,041375664,	026065254,
216	,	7851	,020200053,	003373656,
2245,	1162	,022017103,	015754234,
726	,	7659	,067327102,	036032344,
1966,	1156	,007154144,	000456573,
670	,	2672	,045367715,	020772116,
4130,	6043	,046775773,	004657766,
53	,	2862	,037123271,	011652043,
4830,	180		,034054132,	063673657,
182	,	2663	,036632600,	006140620,
2181,	6940	,043776172,	042103455,
2006,	1645	,013675272,	071143561,
1080,	1582	,053755564,	007122624,
2288,	951		,060621674,	032065524,
2027,	6878	,022415634,	047205733,
271	,	7701	,037363473,	071732000,
915	,	1823	,077262176,	011057010,
497	,	2391	,057132462,	060447016,
139	,	2606	,013314107,	077551540,
3693,	822		,054474504,	054256322,
2054,	6403	,076023074,	061777241,
4342,	239		,060652454,	037175533,
3342,	442		,031371623,	000254400,
2592,	6769	,052134040,	051277171,
1007,	2560	,041013755,	057767521,
310	,	2502	,020323763,	060063316,
4203,	5072	,052445270,	012771226,
455	,	7268	,050735662,	051142373,
4318,	341		,027571255,	047160627

	};

	int weilandp_pilot[] =
	{
		796	,	7575	,071676756	,013053205,
156	,	2369	,060334021	,046604773,
4198,	5688	,024562714	,060007065,
3941,	539		,061011650	,023616424,
1374,	2270	,067337730	,066243127,
1338,	7306	,023762642	,033630334,
1833,	6457	,025365366	,043456307,
2521,	6254	,057226722	,076521063,
3175,	5644	,072643175	,052465264,
168	,	7119	,000236125	,076142064,
2715,	1402	,012071371	,060232627,
4408,	5557	,061136116	,005607727,
3160,	5764	,036261215	,077737367,
2796,	1073	,013607013	,016031533,
459	,	7001	,031010541	,055416670,
3594,	5910	,073163062	,033076260,
4813,	10060	,030250537	,073355574,
586	,	2710	,056226421	,042437243,
1428,	1546	,026205736	,066470710,
2371,	6887	,002450570	,054366756,
2285,	1883	,066511327	,023666556,
3377,	5613	,006323465	,074622250,
4965,	5062	,010633350	,016402734,
3779,	1038	,010544206	,054230354,
4547,	10170	,043714115	,037167223,
1646,	6484	,055641056	,056136734,
1430,	1718	,026572456	,062211315,
607	,	2535	,075123401	,040615033,
2118,	1158	,070041254	,063213062,
4709,	526		,053034467	,003066540,
1149,	7331	,050733517	,030062510,
3283,	5844	,073077145	,034360276,
2473,	6423	,055454316	,045431517,
1006,	6968	,037137206	,047647044,
3670,	1280	,045724432	,033773217,
1817,	1838	,055560467	,077620561,
771	,	1989	,013467065	,017327352,
2173,	6468	,024245150	,062223375,
740	,	2091	,022265044	,067665257,
1433,	1581	,010003471	,027515010,
2458,	1453	,036537736	,037705710,
3459,	6252	,057706617	,076736116,
2155,	7122	,076411007	,077202566,
1205,	7711	,061643153	,025334277,
413	,	7216	,050125760	,070220333,
874	,	2113	,066657234	,022376763,
2463,	1095	,001350500	,031043217,
1106,	1628	,043621551	,020166102,
1590,	1713	,042435620	,016423062,
3873,	6102	,074327566	,031245527,
4026,	6123	,044553226	,037160613,
4272,	6070	,052231514	,003414402,
3556,	1115	,046576047	,004003162,
128	,	8047	,046312270	,054703562,
1200,	6795	,004717127	,025225202,
130	,	2575	,050407031	,031643432,
4494,	53		,010044104	,027063234,
1871,	1729	,036610123	,040756155,
3073,	6388	,073470741	,024774305,
4386,	682		,024072445	,051507057,
4098,	5565	,007765425	,012225744,
1923,	7160	,032242545	,062104320,
1176,	2277	,003210227	,056250500

	};

	int overlaycodetable[] = {
	269		,1889	,027516364	,067377026,
	1448	,1268	,056523173	,022276405,
	1028	,1593	,013575116	,064256064,
	1324	,1186	,046450720	,022541050,
	822		,1239	,012131561	,065326055,
	5		,1930	,017464233	,072132153,
	155		,176	,065053061	,004514276,
	458		,1696	,071707375	,063530655,
	310		,26		,034213032	,035460510,
	959		,1344	,046160454	,071144703,
	1238	,1271	,042153002	,045741561,
	1180	,1182	,023004216	,034642255,
	1288	,1381	,075723150	,024051066,
	334		,1604	,031622150	,002232734,
	885		,1333	,077044051	,016722614,
	1362	,1185	,057236013	,004521371,
	181		,31		,063564466	,062033045,
	1648	,704	,070454263	,021634063,
	838		,1190	,014276724	,064030307,
	313		,1646	,034631517	,036355573,
	750		,1385	,066647441	,022662277,
	225		,113	,056655305	,007135537,
	1477	,860	,044120321	,013737416,
	309		,1656	,001401156	,077676406,
	108		,1921	,071446113	,033352240,
	1457	,1173	,065511011	,024006552,
	149		,1928	,023206551	,020557017,
	322		,57		,077770161	,014726030,
	271		,150	,074540673	,017203546,
	576		,1214	,071611373	,023731232,
	1103	,1148	,037057206	,037773355,
	450		,1458	,023025164	,041547173,
	399		,1519	,041327640	,070714166,
	241		,1635	,061120023	,046232706,
	1045	,1257	,006234040	,037305130,
	164		,1687	,074425523	,000744320,
	513		,1382	,030506176	,007273204,
	687		,1514	,042154245	,043674256,
	422		,1		,011240471	,071100451,
	303		,1583	,032430440	,002111760,
	324		,1806	,045423343	,017414124,
	495		,1664	,004254573	,055250612,
	725		,1338	,000100444	,043330066,
	780		,1111	,010223615	,050630424,
	367		,1706	,047340430	,006777411,
	882		,1543	,065721741	,051654600,
	631		,1813	,056006024	,065061571,
	37		,228	,042262216	,027652771,
	647		,2871	,002226642	,074310663,
	1043	,2884	,030472126	,075564321,
	24		,1823	,044032145	,072312644,
	120		,75		,054551571	,006432203,
	134		,11		,040710042	,074277066,
	136		,63		,001560736	,051754340,
	158		,1937	,011725354	,054647123,
	214		,22		,047676432	,011456125,
	335		,1768	,025530310	,066634346,
	340		,1526	,034717545	,061553336,
	661		,1402	,051512234	,040357216,
	889		,1445	,001645770	,063375367,
	929		,1680	,005363453	,073263151,
	1002	,1290	,076720135	,037304627,
	1149	,1245	,024724407	,027051216
	};


	if (satid >= 64)
	{
		printf("err in BDSB1Ccodegen satid %d\n", satid);
		return;
	}


	j = (N - 1) / 2;
	memset(Legendre, 0, sizeof(char) * N);
	for (i = 1; i <= j; i++)
	{
		k = (i * i) % N;
		Legendre[k] = 1;
	}

	p_weil = weilandp_pilot[satid * 4 + 0];
	p_insert = weilandp_pilot[satid * 4 + 1];
	d_weil = weilandp_data[satid * 4 + 0];
	d_insert = weilandp_data[satid * 4 + 1];

	o_weil = overlaycodetable[satid * 4 + 0];
	o_insert = overlaycodetable[satid * 4 + 1];

	flag[0] = BDSB1Cfrom_weil_to_rangecode(p_weil, p_insert, Legendre, Pcode);
	flag[1] = BDSB1Cfrom_weil_to_rangecode(d_weil, d_insert, Legendre, Dcode);
	flag[2] = BDSB1Coverlaycodegen(o_weil, o_insert, overlay);

	if (flag[0] & flag[1] & flag[2])
	{
		for (int i = 0; i < 10230; i++)
		{
			pilotcode[i] = Pcode[i] * 2 - 1;
			datacode[i] = Dcode[i] * 2 - 1;
		}
		for (int i = 0; i < 1800; i++)
		{
			overlay[i] = overlay[i] * 2 - 1;
		}
	}
	else
	{
		printf("code error!");
		while (1) {}
	}
	
	//if (satid > 5 && satid < 8)
	//{
	//	FILE* tp1;
	//	char* str = NULL;
	//	str = (char*)malloc(10);
	//	sprintf(str, "%dPCODE.txt", satid);
	//	tp1 = fopen(str, "w");
	//	for (int i = 0; i < 24; i++)
	//	{
	//		fprintf(tp1, "%d", Pcode[i]);
	//	}
	//	fprintf(tp1, "\n");
	//	for (int i = 24; i > 0; i--)
	//	{
	//		fprintf(tp1, "%d", Pcode[10230 - i]);
	//	}
	//	fclose(tp1);
	//}


}

int BDSB1Cfrom_weil_to_rangecode(int weil, int insertindex, char* L, int* rangecode)
{
	int i;
	char weilcode[10243];

	for (i = 0; i < 10243; i++)
	{
		weilcode[i] = (L[i] + L[(i + weil) % 10243]) % 2;
	}

	for (i = 0; i < 10230; i++)
	{
		rangecode[i] = weilcode[(i + insertindex - 1) % 10243];
	}

	return 1;

}




int BDSB1Coverlaycodegen(int weil, int insertindex, int* overlaycode)
{
	int tmp;
	int N = 3607;
	char L[3607];
	char weilcode[3607];
	int i, j, k;
	//	FILE* fp;
	//	fp=fopen("overlaycode.txt","a");
	j = (N - 1) / 2;
	memset(L, 0, sizeof(char) * N);
	for (i = 1; i <= j; i++)
	{
		k = (i * i) % N;
		L[k] = 1;
	}

	for (i = 0; i < N; i++)
	{
		weilcode[i] = (L[i] + L[(i + weil) % N]) % 2;
	}

	for (i = 0; i < 1800; i++)
	{
		overlaycode[i] = weilcode[(i + insertindex - 1) % N];
	}
	return 1;
}


void B1C_Nav_Gen(int* nav)
{
	for (int i = 0; i < 1800; i++)
	{
		nav[i] = rand()%2;
		nav[i] = nav[i] * 2 - 1;
	}
}